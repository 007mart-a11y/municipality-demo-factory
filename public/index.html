<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI asistent obce ‚Äì DEMO</title>

  <style>
    :root{
      --accent:#00E5FF;
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.72);

      --overlay: rgba(8, 12, 20, .30);
      --overlay2: rgba(8, 12, 20, .46);

      --stroke: rgba(255,255,255,.12);

      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --bubbleShadow: 0 14px 40px rgba(0,0,0,.28);

      --radius: 18px;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: #0b1220;
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
    }

    /* ===== Background ===== */
    .bg{
      position: fixed;
      inset: 0;
      z-index:0;
      background:
        radial-gradient(1200px 700px at 25% 0%, rgba(0,229,255,.14), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)),
        #0b1220;
    }
    .bgImg{
      position:absolute; inset:0;
      background-size: cover;
      background-position: center;
      opacity:.92;
      transform: scale(1.03);
      filter: saturate(1.02) contrast(1.02);
    }
    .bgShade{
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 900px at 30% 20%, transparent 40%, rgba(0,0,0,.55) 100%),
        linear-gradient(90deg, rgba(11,18,32,.82), rgba(11,18,32,.35));
      pointer-events:none;
    }

    /* ===== Optional top note (you can delete this whole block later) ===== */
    .topNote{
      position: relative;
      z-index:1;
      max-width: 1100px;
      margin: 18px auto 0;
      padding: 0 18px;
      display:flex;
      justify-content:flex-start;
    }
    .noteCard{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 14px 16px;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(10,16,28,.45);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    .noteBadge{
      width: 38px; height: 38px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,229,255,.12);
      border: 1px solid rgba(0,229,255,.20);
      font-weight: 900;
      flex: 0 0 auto;
    }
    .noteTxt{min-width:0;}
    .noteTxt b{letter-spacing:.2px;}
    .noteTxt .s{
      margin-top:4px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .noteTxt code{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
    }

    /* ===== Side Tab "Porad√≠me v√°m" ===== */
    .tab{
      position: fixed;
      right: 14px;
      bottom: calc(18px + env(safe-area-inset-bottom));
      z-index: 50;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,16,28,.60);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.48);
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, background .2s ease;
    }
    .tab:hover{ transform: translateY(-1px); background: rgba(10,16,28,.72); }

    .tab .pill{
      height: 34px;
      padding: 0 14px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      font-weight: 900;
      background: linear-gradient(180deg, rgba(0,229,255,.20), rgba(0,229,255,.10));
      border: 1px solid rgba(0,229,255,.25);
    }
    .tab .mini{
      display:flex; flex-direction:column;
      gap:2px;
      line-height:1.1;
      max-width: 220px;
    }
    .tab .mini .a{ font-weight: 900; font-size: 12px; }
    .tab .mini .b{ font-size: 11px; color: var(--muted); white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .tab.blink{
      animation: pulse 1.8s infinite ease-in-out;
    }
    @keyframes pulse{
      0%,100%{ box-shadow: 0 18px 50px rgba(0,0,0,.48); }
      50%{ box-shadow: 0 18px 50px rgba(0,229,255,.22); }
    }

    /* ===== Chat Overlay Shell (NO big frame) ===== */
    .shell{
      position: fixed;
      right: 14px;
      bottom: 14px;
      width: 410px;
      height: 640px;
      max-height: calc(100dvh - 28px);
      z-index: 70;

      display:none;
      overflow:hidden;
      border-radius: 24px;

      /* instead of a "frame", we use a soft overlay + blur */
      background: linear-gradient(180deg, rgba(8,12,20,.24), rgba(8,12,20,.45));
      backdrop-filter: blur(14px);

      /* no visible border like a box */
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
    }
    .shell.open{ display:flex; flex-direction:column; }

    /* Header minimal, like "floating bar" */
    .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;

      padding: 12px 12px 10px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .barLeft{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .mark{
      width: 34px; height: 34px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,229,255,.12);
      border: 1px solid rgba(0,229,255,.22);
      font-weight: 900;
      flex:0 0 auto;
    }
    .barTxt{min-width:0;}
    .barTitle{
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 250px;
    }
    .barSub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 250px;
    }

    .barRight{ display:flex; align-items:center; gap:8px; }
    .chip{
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .iconBtn{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size: 14px;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.07); }

    /* Pills top */
    .pillbar{
      padding: 10px 12px 0;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      background: transparent;
    }
    .pillQ{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
    }
    .pillQ:hover{ background: rgba(255,255,255,.07); }

    /* ===== Chat area (transparent) ===== */
    .chat{
      flex: 1 1 auto;
      padding: 12px 12px 8px;
      overflow:auto;
      background: transparent;
    }

    /* Message layout: only bubbles have borders (like Jiƒç√≠n) */
    .msg{ display:flex; margin: 10px 0; }
    .msg.user{ justify-content:flex-end; }

    .bubble{
      max-width: 86%;
      padding: 10px 12px;
      border-radius: 18px;
      line-height: 1.35;
      font-size: 13px;
      word-break: break-word;

      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: var(--bubbleShadow);
    }

    .msg.ai .bubble{
      border-color: rgba(0,229,255,.18);
      background: rgba(0,229,255,.08);
    }
    .msg.user .bubble{
      border-color: rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
    }

    .bubble a{ color: var(--accent); text-decoration:none; }
    .bubble a:hover{ text-decoration:underline; }

    /* typing dots (animated) */
    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .typing span{
      width: 7px; height: 7px;
      border-radius: 999px;
      background: rgba(234,241,255,.90);
      opacity: .35;
      animation: bounce 1s infinite ease-in-out;
    }
    .typing span:nth-child(2){ animation-delay: .12s; }
    .typing span:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%, 100%{ transform: translateY(0); opacity: .35; }
      50%{ transform: translateY(-4px); opacity: 1; }
    }

    /* Feedback block */
    .feedback{
      max-width: 92%;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(8,12,20,.42);
      backdrop-filter: blur(10px);
    }
    .feedback .q{ font-weight: 950; margin-bottom: 8px; }
    .feedback .btns{ display:flex; gap:10px; }
    .fbBtn{
      flex: 1;
      padding: 9px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }
    .fbBtn.yes{
      border-color: rgba(0,229,255,.26);
      background: rgba(0,229,255,.10);
    }
    .fbBtn:hover{ background: rgba(255,255,255,.09); }
    .fbBtn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Input row - modern, no big bottom bar */
    .inputRow{
      padding: 10px 12px 12px;
      background: rgba(255,255,255,.02);
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input{
      flex: 1;
      height: 46px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;

      /* iOS zoom fix */
      font-size: 16px;
    }
    .send{
      width: 46px; height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(0,229,255,.30);
      background: rgba(0,229,255,.12);
      color: var(--text);
      font-weight: 1000;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .send:disabled{ opacity:.55; cursor:not-allowed; }

    .foot{
      padding: 0 12px 10px;
      font-size: 11px;
      color: rgba(234,241,255,.58);
    }

    /* Mobile */
    @media (max-width: 520px){
      .shell{
        right: 10px;
        left: 10px;
        width: auto;
        height: calc(100dvh - 20px);
        bottom: 10px;
        border-radius: 20px;
      }
      .barTitle{ max-width: 190px; }
      .barSub{ max-width: 190px; }
      .tab{ right: 10px; }
    }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true">
    <div class="bgImg" id="bgImg"></div>
    <div class="bgShade"></div>
  </div>

  <div class="topNote">
    <div class="noteCard">
      <div class="noteBadge">AI</div>
      <div class="noteTxt">
        <b>AI asistent obce ‚Äì DEMO</b>
        <div class="s">
          Otev≈ôete chat boƒçn√≠ li≈°tou <b>‚ÄûPorad√≠me v√°m‚Äú</b>. P≈ôepnut√≠ obce p≈ôes URL:
          <code>?obec=hradec-kralove</code> / <code>?obec=radim</code> / <code>?obec=zeleznice</code>
        </div>
      </div>
    </div>
  </div>

  <!-- Side tab -->
  <div class="tab blink" id="openTab" role="button" aria-label="Otev≈ô√≠t chat">
    <div class="pill">Porad√≠me v√°m</div>
    <div class="mini">
      <div class="a" id="tabTitle">AI asistent obce</div>
      <div class="b" id="tabSub">Kliknƒõte a napi≈°te dotaz‚Ä¶</div>
    </div>
  </div>

  <!-- Chat shell (modern overlay, no heavy frame) -->
  <div class="shell" id="shell" aria-live="polite">
    <div class="bar">
      <div class="barLeft">
        <div class="mark" id="mark">AI</div>
        <div class="barTxt">
          <div class="barTitle" id="headerTitle">Uk√°zka pro obec</div>
          <div class="barSub" id="headerSub">Zeptejte se na kontakty, √∫≈ôedn√≠ hodiny‚Ä¶</div>
        </div>
      </div>

      <div class="barRight">
        <div class="chip">DEMO</div>
        <button class="iconBtn" id="resetBtn" title="Reset">‚Üª</button>
        <button class="iconBtn" id="closeBtn" title="Zav≈ô√≠t">‚úï</button>
      </div>
    </div>

    <div class="pillbar">
      <span class="pillQ" data-q="Jak√© jsou √∫≈ôedn√≠ hodiny?">√ö≈ôedn√≠ hodiny</span>
      <span class="pillQ" data-q="Jak√Ω je kontakt na √∫≈ôad?">Kontakt</span>
      <span class="pillQ" data-q="Kde je bioodpad a kdy je otev≈ôeno?">Bioodpad</span>
      <span class="pillQ" data-q="Jak se plat√≠ poplatek za odpad?">Poplatek za odpad</span>
      <span class="pillQ" data-q="Kde na webu najdu √∫≈ôedn√≠ desku?">√ö≈ôedn√≠ deska</span>
    </div>

    <div class="chat" id="chat"></div>

    <div class="inputRow">
      <input class="input" id="inp" type="text" placeholder="Napi≈°te dotaz‚Ä¶" autocomplete="off" />
      <button class="send" id="send" type="button">‚û§</button>
    </div>

    <div class="foot" id="status"></div>
  </div>

  <script>
    const openTab = document.getElementById('openTab');
    const shell = document.getElementById('shell');
    const closeBtn = document.getElementById('closeBtn');
    const resetBtn = document.getElementById('resetBtn');

    const chat = document.getElementById('chat');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');

    const headerTitle = document.getElementById('headerTitle');
    const headerSub = document.getElementById('headerSub');
    const tabTitle = document.getElementById('tabTitle');
    const tabSub = document.getElementById('tabSub');
    const mark = document.getElementById('mark');

    const bgImg = document.getElementById('bgImg');

    function getParam(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }
    function normalizeSlug(value){
      if (!value) return "";
      return value.toLowerCase().trim()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "");
    }
    function inferSlug(){
      const q = normalizeSlug(getParam("obec"));
      if (q) return q;

      const parts = location.pathname.split('/').filter(Boolean).map(x => x.toLowerCase());
      if (!parts.length) return "radim";
      if (parts[0] === "skins" || parts[0] === "registry") return "radim";
      if ((parts[0] === "demo" || parts[0] === "obec") && parts[1]) return normalizeSlug(parts[1]);
      return normalizeSlug(parts[0]) || "radim";
    }

    function linkify(text){
      const urlRegex = /(https?:\/\/[^\s)]+)\b/g;
      return String(text).replace(urlRegex, (url) => {
        const safe = url.replace(/"/g, "%22");
        return `<a href="${safe}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    function add(role, htmlOrText, opts = {}){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');

      if (opts.type === "feedback"){
        wrap.innerHTML = htmlOrText;
      } else {
        const b = document.createElement('div');
        b.className = 'bubble';
        b.innerHTML = linkify(htmlOrText);
        wrap.appendChild(b);
      }

      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      return wrap;
    }

    function addTyping(){
      const wrap = document.createElement('div');
      wrap.className = 'msg ai';
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerHTML = `<span class="typing" aria-label="Generuje se odpovƒõƒè">
        <span></span><span></span><span></span>
      </span>`;
      wrap.appendChild(b);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
      return wrap;
    }

    async function loadRegistry(){
      try{
        const res = await fetch('/registry/municipalities.json', { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }
    function pickMunicipality(reg, slug){
      if (!reg) return null;
      if (Array.isArray(reg)) return reg.find(m => m && (m.slug === slug || m.id === slug)) || null;
      if (Array.isArray(reg.municipalities)) return reg.municipalities.find(m => m && (m.slug === slug || m.id === slug)) || null;
      if (reg[slug]) return { slug, ...reg[slug] };
      return null;
    }

    function setAccent(color){
      if (!color) return;
      document.documentElement.style.setProperty('--accent', color);
    }

    // ‚úÖ IMPORTANT: no HEAD fetch. Uses Image preload.
    function setBackgroundForSlug(slug){
      const url = `/skins/${slug}/bg.jpg`;
      const img = new Image();
      img.onload = () => { bgImg.style.backgroundImage = `url('${url}')`; };
      img.onerror = () => {
        bgImg.style.backgroundImage = '';
        console.warn('Pozad√≠ nenalezeno:', url);
      };
      img.src = url;
    }

    // ===== State =====
    let slug = inferSlug();
    const THREAD_KEY = () => `municipality_thread_id_v4_${slug}`;
    let threadId = localStorage.getItem(THREAD_KEY()) || null;

    let regCache = null;
    let muni = null;

    let userQCount = 0;
    let feedbackShown = false;

    function openChat(){
      shell.classList.add('open');
      openTab.classList.remove('blink');
      openTab.style.display = 'none';
      setTimeout(() => inp.focus(), 50);
    }
    function closeChat(){
      shell.classList.remove('open');
      openTab.style.display = 'flex';
      openTab.classList.add('blink');
    }
    function resetConversation(){
      localStorage.removeItem(THREAD_KEY());
      threadId = null;
      userQCount = 0;
      feedbackShown = false;
      chat.innerHTML = '';

      const name = muni?.name || slug;
      add('ai', `Resetov√°no. Zeptejte se znovu (obec: ${name}).`);
      inp.focus();
    }

    function showFeedbackCard(){
      if (feedbackShown) return;
      feedbackShown = true;

      const phone = muni?.contact_phone || muni?.phone || muni?.tel || null;
      const name = muni?.name || slug;

      const html = `
        <div class="feedback">
          <div class="q">Na≈°li jste odpovƒõƒè?</div>
          <div class="btns">
            <button class="fbBtn yes" data-fb="yes">Ano</button>
            <button class="fbBtn" data-fb="no">Ne</button>
          </div>
        </div>
      `;

      const wrap = add('ai', html, { type: "feedback" });

      wrap.querySelectorAll('button[data-fb]').forEach(btn => {
        btn.addEventListener('click', () => {
          const v = btn.getAttribute('data-fb');
          wrap.querySelectorAll('button').forEach(b => b.disabled = true);

          if (v === "yes"){
            add('ai', `Super, jsem r√°d, ≈æe jsem pomohl ‚úÖ Kdykoliv se zeptejte znovu.`);
          } else {
            const extra = phone
              ? `Pokud chcete, obra≈•te se p≈ô√≠mo na √∫≈ôad (telefon: ${phone}).`
              : `Pokud chcete, obra≈•te se p≈ô√≠mo na √∫≈ôad ‚Äì kontakt najdete na ofici√°ln√≠m webu obce.`;
            add('ai', `Mrz√≠ mƒõ to üôè Zkuste pros√≠m dotaz up≈ôesnit (nap≈ô. uveƒète konkr√©tn√≠ slu≈æbu / m√≠sto / term√≠n). ${extra}`);
          }
        });
      });
    }

    async function init(){
      regCache = await loadRegistry();
      muni = pickMunicipality(regCache, slug);

      const displayName = muni?.name || slug;

      headerTitle.textContent = `Uk√°zka pro obec: ${displayName}`;
      headerSub.textContent = "Zeptejte se na kontakty, √∫≈ôedn√≠ hodiny, odpady, poplatky‚Ä¶";

      tabTitle.textContent = displayName;
      tabSub.textContent = "Kliknƒõte a napi≈°te dotaz‚Ä¶";

      if (muni?.theme?.primary) setAccent(muni.theme.primary);

      setBackgroundForSlug(slug);

      chat.innerHTML = '';
      add('ai', `Dobr√Ω den üëã Jsem uk√°zkov√Ω AI asistent pro obec ${displayName}. Jak v√°m mohu pomoci?`);
    }

    async function ask(q){
      const msg = (q ?? inp.value).trim();
      if (!msg) return;

      add('user', msg);
      inp.value = '';
      sendBtn.disabled = true;

      const typingEl = addTyping();

      try{
        const res = await fetch('/.netlify/functions/search', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message: msg, thread_id: threadId, obec: slug })
        });

        const data = await res.json().catch(() => ({}));
        typingEl.remove();

        if (!res.ok || !data.ok){
          add('ai', 'Omlouv√°m se, teƒè se mi nepoda≈ôilo odpovƒõdƒõt. Zkuste to pros√≠m znovu.');
        } else {
          const answer = (data.answer || '').trim();
          add('ai', answer || 'Omlouv√°m se, nepoda≈ôilo se mi naj√≠t odpovƒõƒè.');

          if (data.thread_id){
            threadId = data.thread_id;
            localStorage.setItem(THREAD_KEY(), threadId);
          }

          userQCount += 1;
          if (userQCount >= 2) showFeedbackCard();
        }
      } catch(e){
        typingEl.remove();
        add('ai', 'Omlouv√°m se, do≈°lo k chybƒõ p≈ôipojen√≠. Zkuste to pros√≠m znovu.');
      } finally {
        sendBtn.disabled = false;
        inp.focus();
      }
    }

    // Events
    openTab.addEventListener('click', openChat);
    closeBtn.addEventListener('click', closeChat);
    resetBtn.addEventListener('click', resetConversation);

    sendBtn.addEventListener('click', () => ask());
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') ask(); });

    document.querySelectorAll('[data-q]').forEach(el => {
      el.addEventListener('click', () => ask(el.getAttribute('data-q')));
    });

    init();
  </script>
</body>
</html>
