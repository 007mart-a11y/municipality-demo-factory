<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI asistent obce ‚Äì DEMO</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --panel2:#08102a;
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --border:rgba(255,255,255,.10);
      --accent:#00E5FF;
      --shadow: 0 20px 55px rgba(0,0,0,.55);
    }

    /* ===== Page background (skin) ===== */
    body{
      margin:0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 30% 0%, rgba(0,229,255,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)),
        var(--bg);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* ===== Lightweight landing (so background is visible) ===== */
    .hero{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 18px 18px;
    }
    .heroCard{
      background: rgba(15,26,51,.55);
      border:1px solid var(--border);
      border-radius:18px;
      padding: 16px 16px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .heroH1{
      margin:0 0 6px;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .heroP{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .heroHint{
      margin-top: 10px;
      color: rgba(232,238,252,.62);
      font-size: 12px;
    }

    /* ===== Side TAB launcher ===== */
    .sideTab{
      position: fixed;
      right: 0;
      top: 45%;
      transform: translateY(-50%);
      z-index: 9999;

      display:flex;
      align-items:center;
      gap:10px;

      padding: 12px 12px 12px 14px;
      border-radius: 14px 0 0 14px;
      border:1px solid rgba(0,229,255,.28);
      border-right: none;

      background: rgba(8,16,42,.88);
      backdrop-filter: blur(8px);
      cursor:pointer;
      user-select:none;

      box-shadow: 0 14px 40px rgba(0,0,0,.45);
      transition: transform .15s ease, background .15s ease;
    }
    .sideTab:hover{
      transform: translateY(-50%) translateX(-2px);
      background: rgba(8,16,42,.94);
    }
    .tabIcon{
      width: 30px;
      height: 30px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,229,255,.12);
      border:1px solid rgba(0,229,255,.22);
      font-size: 16px;
      flex:0 0 auto;
    }
    .tabText{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      padding-right: 6px;
    }
    .tabText strong{
      font-size: 12px;
      letter-spacing: .2px;
    }
    .tabText span{
      font-size: 11px;
      color: rgba(232,238,252,.72);
    }

    /* gentle blinking */
    .blink{
      animation: pulseGlow 2.4s ease-in-out infinite;
    }
    @keyframes pulseGlow{
      0%, 100% { box-shadow: 0 14px 40px rgba(0,0,0,.45), 0 0 0 rgba(0,229,255,.00); }
      50%      { box-shadow: 0 14px 40px rgba(0,0,0,.45), 0 0 18px rgba(0,229,255,.24); }
    }

    /* ===== Side chat drawer ===== */
    .drawerBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .drawerBackdrop.open{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: min(420px, 92vw);
      z-index: 9999;

      transform: translateX(100%);
      transition: transform .22s ease;
      display:flex;
      flex-direction:column;

      background: rgba(15,26,51,.92);
      border-left: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      box-shadow: -20px 0 55px rgba(0,0,0,.55);
    }
    .drawer.open{
      transform: translateX(0);
    }

    .drawerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .hdrLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .hdrIcon{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,229,255,.10);
      border:1px solid rgba(0,229,255,.18);
      font-size: 18px;
      flex:0 0 auto;
    }
    .hdrText{
      min-width:0;
    }
    .hdrTitle{
      font-weight: 800;
      font-size: 13px;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }
    .hdrSub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }
    .hdrRight{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .badge{
      font-size: 11px;
      padding: 5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .btnGhost{
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      user-select:none;
    }
    .btnGhost:hover{ background: rgba(255,255,255,.07); }

    .pillbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding: 10px 12px 8px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .pill{
      padding: 7px 10px;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:999px;
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      user-select:none;
      font-size: 12px;
    }
    .pill:hover { background: rgba(255,255,255,0.07); }

    .chat{
      flex: 1;
      overflow:auto;
      padding: 12px;
      background: rgba(8,16,42,.55);
    }

    .msg{ margin: 10px 0; display:flex; }
    .msg.user{ justify-content:flex-end; }

    .bubble{
      max-width: 86%;
      padding: 10px 12px;
      border-radius: 14px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
      border:1px solid rgba(255,255,255,.10);
      font-size: 13px;
    }
    .user .bubble{
      background: rgba(255,255,255,.06);
      border-color: rgba(0,229,255,0.20);
    }
    .ai .bubble{
      background: rgba(0,229,255,.08);
      border-color: rgba(0,229,255,.14);
    }
    .bubble a{ color: var(--accent); text-decoration: none; }
    .bubble a:hover{ text-decoration: underline; }

    .inputRow{
      display:flex;
      gap:10px;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    input{
      flex:1;
      padding: 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.14);
      background:#071026;
      color: var(--text);
      outline:none;
    }
    .sendBtn{
      padding: 12px 14px;
      border-radius: 12px;
      border:1px solid rgba(0,229,255,0.35);
      background: rgba(0,229,255,0.10);
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
    }
    .sendBtn:disabled{ opacity:.6; cursor:not-allowed; }

    .status{
      padding: 0 12px 12px;
      font-size: 12px;
      color: rgba(232,238,252,.70);
    }
  </style>
</head>

<body>
  <div class="hero">
    <div class="heroCard">
      <div class="heroH1">AI asistent obce ‚Äì DEMO</div>
      <div class="heroP">
        Uk√°zka chatu pro obƒçany (kontakty, √∫≈ôedn√≠ hodiny, odpady, poplatky‚Ä¶). Otev≈ôete chat boƒçn√≠ li≈°tou vpravo.
      </div>
      <div class="heroHint">
        Tip: po≈°lete odkaz ve tvaru <code>/hradec-kralove/</code>, <code>/zeleznice/</code> apod.
      </div>
    </div>
  </div>

  <!-- Side tab launcher -->
  <div id="sideTab" class="sideTab blink" role="button" aria-label="Otev≈ô√≠t chat">
    <div class="tabIcon">ü§ñ</div>
    <div class="tabText">
      <strong>Otev≈ô√≠t chat</strong>
      <span id="tabSub">DEMO pro obec</span>
    </div>
  </div>

  <!-- Backdrop + Drawer -->
  <div id="backdrop" class="drawerBackdrop"></div>

  <aside id="drawer" class="drawer" aria-label="Chat">
    <div class="drawerHeader">
      <div class="hdrLeft">
        <div class="hdrIcon" aria-hidden="true">ü§ñ</div>
        <div class="hdrText">
          <div class="hdrTitle" id="headerTitle">Uk√°zka DEMO pro obec</div>
          <div class="hdrSub" id="headerSub">Zeptejte se na kontakty, √∫≈ôedn√≠ hodiny, odpady‚Ä¶</div>
        </div>
      </div>
      <div class="hdrRight">
        <div class="badge">DEMO</div>
        <button class="btnGhost" id="resetTop" type="button">Reset</button>
        <button class="btnGhost" id="closeBtn" type="button">‚úï</button>
      </div>
    </div>

    <div class="pillbar">
      <span class="pill" data-q="Jak√© jsou √∫≈ôedn√≠ hodiny?">√ö≈ôedn√≠ hodiny</span>
      <span class="pill" data-q="Jak√Ω je kontakt na mƒõstsk√Ω/obecn√≠ √∫≈ôad?">Kontakt</span>
      <span class="pill" data-q="Kde je bioodpad a kdy je otev≈ôeno?">Bioodpad</span>
      <span class="pill" data-q="Jak se plat√≠ poplatek za odpad?">Poplatek za odpad</span>
      <span class="pill" data-q="Kde na webu najdu √∫≈ôedn√≠ desku?">√ö≈ôedn√≠ deska</span>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="inputRow">
      <input id="inp" type="text" placeholder="Napi≈°te dotaz‚Ä¶" autocomplete="off" />
      <button class="sendBtn" id="send" type="button">Odeslat</button>
    </div>

    <div class="status" id="status"></div>
  </aside>

  <script>
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const sideTab = document.getElementById('sideTab');
    const closeBtn = document.getElementById('closeBtn');

    const chat = document.getElementById('chat');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');

    const headerTitle = document.getElementById('headerTitle');
    const headerSub = document.getElementById('headerSub');
    const tabSub = document.getElementById('tabSub');
    const resetTop = document.getElementById('resetTop');

    function getParam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }
    function normalizeSlug(value) {
      if (!value) return "";
      return value.toLowerCase().trim()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "");
    }
    function inferSlugFromUrl() {
      const parts = location.pathname.split('/').filter(Boolean).map(x => x.toLowerCase());
      if (parts.length) {
        if ((parts[0] === "demo" || parts[0] === "obec") && parts[1]) return normalizeSlug(parts[1]);
        return normalizeSlug(parts[0]);
      }
      return normalizeSlug(getParam("obec") || "radim") || "radim";
    }

    // ===== Skin background =====
    let slug = inferSlugFromUrl();

    (function applySkinBackground(){
      const url = `/skins/${slug}.jpg`;

      document.body.style.backgroundImage =
        `linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.64)), url("${url}")`;
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center";
      document.body.style.backgroundAttachment = "fixed";
      document.body.style.backgroundRepeat = "no-repeat";
    })();

    // linkify URL
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s)]+)\b/g;
      return String(text).replace(urlRegex, (url) => {
        const safe = url.replace(/"/g, "%22");
        return `<a href="${safe}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }
    function sanitizeAnswerFront(text){
      if (!text) return text;
      return String(text)
        .replace(/„Äê[^„Äë]{1,200}„Äë/g, "")
        .replace(/^\s*(zdroj|zdroje|source|sources|citace|reference)s?\s*:.*$/gim, "")
        .replace(/404|not found|cannot fetch|error fetching/gi, "")
        .replace(/\n{3,}/g, "\n\n")
        .trim();
    }

    function add(role, text) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerHTML = linkify(text);
      wrap.appendChild(b);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    async function loadRegistry() {
      try {
        const res = await fetch('/registry/municipalities.json', { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }
    function pickMunicipality(reg, slug) {
      if (!reg) return null;
      if (Array.isArray(reg)) {
        return reg.find(m => m && (m.slug === slug || m.id === slug)) || null;
      }
      if (Array.isArray(reg.municipalities)) {
        return reg.municipalities.find(m => m && (m.slug === slug || m.id === slug)) || null;
      }
      if (reg[slug]) return { slug, ...reg[slug] };
      return null;
    }

    // thread per slug
    const THREAD_KEY = () => `municipality_thread_id_v3_${slug}`;
    let threadId = localStorage.getItem(THREAD_KEY()) || null;

    // ===== Drawer open/close =====
    function openDrawer(){
      drawer.classList.add('open');
      backdrop.classList.add('open');
      sideTab.classList.remove('blink'); // p≈ôestane blikat po prvn√≠m otev≈ôen√≠
      setTimeout(() => inp.focus(), 50);
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      backdrop.classList.remove('open');
    }

    sideTab.addEventListener('click', openDrawer);
    closeBtn.addEventListener('click', closeDrawer);
    backdrop.addEventListener('click', closeDrawer);

    // ESC closes
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDrawer();
    });

    async function initMunicipality() {
      statusEl.textContent = "";

      const reg = await loadRegistry();
      const m = pickMunicipality(reg, slug);
      const displayName = m?.name || slug;

      headerTitle.textContent = `Uk√°zka DEMO pro obec: ${displayName}`;
      headerSub.textContent = "Zeptejte se na kontakty, √∫≈ôedn√≠ hodiny, odpady, poplatky‚Ä¶";
      tabSub.textContent = displayName;

      add('ai', `Dobr√Ω den üëã Jsem uk√°zkov√Ω AI asistent pro obec ${displayName}. Jak v√°m mohu pomoci?`);
    }

    async function ask(q) {
      const msg = (q ?? inp.value).trim();
      if (!msg) return;

      add('user', msg);
      inp.value = '';
      sendBtn.disabled = true;
      statusEl.textContent = 'Generuje se odpovƒõƒè‚Ä¶';

      add('ai', 'Generuje se odpovƒõƒè‚Ä¶');
      const loadingEl = chat.lastElementChild;

      try {
        const res = await fetch('/.netlify/functions/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msg,
            thread_id: threadId,
            obec: slug
          })
        });

        const data = await res.json().catch(() => ({}));
        if (loadingEl) loadingEl.remove();

        if (!res.ok || !data.ok) {
          add('ai', 'Omlouv√°m se, teƒè se mi nepoda≈ôilo odpovƒõdƒõt. Zkuste to pros√≠m znovu.');
          statusEl.textContent = '';
        } else {
          const answer = sanitizeAnswerFront(data.answer || '');
          add('ai', answer || 'Omlouv√°m se, nepoda≈ôilo se mi naj√≠t odpovƒõƒè.');
          if (data.thread_id) {
            threadId = data.thread_id;
            localStorage.setItem(THREAD_KEY(), threadId);
          }
          statusEl.textContent = '';
        }
      } catch (e) {
        if (loadingEl) loadingEl.remove();
        add('ai', 'Omlouv√°m se, do≈°lo k chybƒõ p≈ôipojen√≠. Zkuste to pros√≠m znovu.');
        statusEl.textContent = '';
      } finally {
        sendBtn.disabled = false;
        inp.focus();
      }
    }

    sendBtn.addEventListener('click', () => ask());
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') ask(); });

    document.querySelectorAll('[data-q]').forEach(el => {
      el.addEventListener('click', () => ask(el.getAttribute('data-q')));
    });

    function resetConversation() {
      localStorage.removeItem(THREAD_KEY());
      threadId = null;
      chat.innerHTML = '';
      add('ai', `Resetov√°no. Zeptejte se znovu (obec: ${slug}).`);
      inp.focus();
    }
    resetTop.addEventListener('click', resetConversation);

    // Init
    initMunicipality();
  </script>
</body>
</html>
