<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI asistent obce ‚Äì DEMO</title>

  <style>
    :root{
      --accent:#1f6fff;            /* modr√° jako ‚ÄúPorad√≠me!‚Äù */
      --accent2:#0ea5ff;
      --bg:#0b1220;
      --text:#0b1220;
      --muted:#5b6678;

      --card:#ffffff;
      --card2:#f6f8fb;
      --border:rgba(20,30,45,.10);

      --shadow: 0 18px 60px rgba(0,0,0,.28);
      --shadow2: 0 10px 24px rgba(0,0,0,.18);

      --radius: 18px;
      --radius2: 14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #0b1220;
      color: #e8eefc;
      overflow-x:hidden;
    }

    /* ======= background skin ======= */
    body.has-skin{
      background-image:
        radial-gradient(900px 520px at 70% 0%, rgba(31,111,255,.22), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.60)),
        var(--skin-url);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }

    /* ======= demo header (jen aby str√°nka nebyla pr√°zdn√°) ======= */
    .demoTop{
      max-width: 980px;
      margin: 0 auto;
      padding: 20px 16px;
    }
    .demoCard{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 14px 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 36px rgba(0,0,0,.26);
    }
    .demoTitle{
      margin:0 0 6px;
      font-size: 16px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .demoSub{
      margin:0;
      font-size: 13px;
      opacity:.85;
      line-height:1.45;
    }
    .demoHint{
      margin-top: 8px;
      font-size: 12px;
      opacity:.75;
    }
    code{ opacity:.95; }

    /* =============================
       Bubble button (collapsed)
       ============================= */
    .bubbleBtn{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px 10px 10px;

      border-radius: 999px;
      background: rgba(255,255,255,.94);
      color: #0b1220;
      border: 1px solid rgba(20,30,45,.10);
      box-shadow: var(--shadow2);

      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .bubbleBtn:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
    }
    .bubbleIcon{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(31,111,255,.18), rgba(31,111,255,.06));
      border: 1px solid rgba(31,111,255,.18);
      font-size: 18px;
      flex:0 0 auto;
    }
    .bubbleText{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .bubbleText strong{
      font-size: 13px;
      font-weight: 900;
      letter-spacing:.1px;
    }
    .bubbleText span{
      font-size: 12px;
      color: rgba(11,18,32,.62);
    }
    .bubbleCta{
      margin-left: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--accent);
      color: #fff;
      font-weight: 800;
      font-size: 12px;
      border: 0;
    }

    /* jemn√© ‚Äúbliknut√≠‚Äù jako pozv√°nka */
    .pulse{
      animation: pulse 3.1s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ box-shadow: var(--shadow2); }
      50%{ box-shadow: var(--shadow2), 0 0 22px rgba(31,111,255,.28); }
    }

    /* =============================
       Chat panel (expanded)
       ============================= */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.32);
      z-index: 9998;
      opacity:0;
      pointer-events:none;
      transition: opacity .16s ease;
    }
    .overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    .panel{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;

      width: min(392px, calc(100vw - 28px));
      height: min(620px, calc(100vh - 28px));

      background: rgba(255,255,255,.96);
      border: 1px solid rgba(20,30,45,.10);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;

      display:flex;
      flex-direction:column;

      transform: translateY(14px);
      opacity:0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
    }
    .panel.open{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    /* top bar */
    .topbar{
      padding: 12px 12px 10px;
      background: linear-gradient(180deg, rgba(31,111,255,.10), rgba(255,255,255,0));
      border-bottom: 1px solid rgba(20,30,45,.08);
      color: var(--text);
    }
    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brandLogo{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(31,111,255,.18), rgba(31,111,255,.06));
      border: 1px solid rgba(31,111,255,.18);
      flex:0 0 auto;
      overflow:hidden;
    }
    .brandLogo img{ width: 24px; height: 24px; object-fit: contain; }
    .brandText{
      min-width:0;
    }
    .brandTitle{
      font-weight: 900;
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 230px;
      letter-spacing:.1px;
    }
    .brandSub{
      font-size: 12px;
      color: rgba(11,18,32,.55);
      margin-top: 2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 230px;
    }

    .topActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .pill{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,30,45,.10);
      background: rgba(255,255,255,.75);
      color: rgba(11,18,32,.70);
      font-weight: 800;
    }
    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(20,30,45,.10);
      background: rgba(255,255,255,.75);
      color: rgba(11,18,32,.85);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .08s ease, background .12s ease;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.92); }
    .iconBtn:active{ transform: scale(.98); }

    /* cards area (welcome + warning) */
    .cards{
      padding: 10px 12px 0;
      background: rgba(255,255,255,.96);
    }
    .msgCard{
      background: var(--card);
      border: 1px solid rgba(20,30,45,.10);
      border-radius: 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      padding: 10px 10px;
      color: var(--text);
      font-size: 12.5px;
      line-height: 1.35;
    }
    .msgCard + .msgCard{ margin-top: 10px; }
    .msgCard .tag{
      display:inline-block;
      font-size: 11px;
      font-weight: 900;
      color: rgba(11,18,32,.70);
      margin-bottom: 6px;
    }

    .warning{
      border: 2px solid rgba(255,90,90,.35);
      background: linear-gradient(180deg, rgba(255,90,90,.10), rgba(255,255,255,1));
    }
    .warning .tag{
      color: rgba(160,30,30,.92);
    }

    /* quick suggestions as ‚Äúchips‚Äù */
    .quick{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding: 10px 12px;
      background: rgba(255,255,255,.96);
      border-bottom: 1px solid rgba(20,30,45,.08);
    }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,30,45,.10);
      background: rgba(246,248,251,1);
      color: rgba(11,18,32,.78);
      font-size: 12px;
      font-weight: 700;
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, transform .08s ease, border-color .12s ease;
    }
    .chip:hover{
      background: rgba(31,111,255,.08);
      border-color: rgba(31,111,255,.20);
    }
    .chip:active{ transform: scale(.98); }

    /* chat log */
    .chat{
      flex: 1;
      overflow:auto;
      padding: 12px 12px 12px;
      background: rgba(255,255,255,.96);
    }
    .row{
      display:flex;
      margin: 10px 0;
    }
    .row.user{ justify-content:flex-end; }
    .bubble{
      max-width: 86%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(20,30,45,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--text);
      background: #fff;
    }
    .row.user .bubble{
      background: linear-gradient(180deg, rgba(31,111,255,.18), rgba(31,111,255,.10));
      border-color: rgba(31,111,255,.22);
    }
    .bubble a{ color: var(--accent); text-decoration:none; }
    .bubble a:hover{ text-decoration:underline; }

    /* input like Jiƒç√≠n pill */
    .composer{
      padding: 10px 12px 12px;
      background: rgba(255,255,255,.96);
      border-top: 1px solid rgba(20,30,45,.08);
    }
    .composerRow{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px;
      border-radius: 999px;
      border: 1px solid rgba(20,30,45,.10);
      background: rgba(246,248,251,1);
    }
    .composerRow input{
      flex:1;
      border: 0;
      outline:none;
      background: transparent;
      padding: 10px 10px;
      font-size: 13px;
      color: rgba(11,18,32,.90);
    }
    .send{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 0;
      background: var(--accent);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 10px 24px rgba(31,111,255,.32);
      transition: transform .08s ease, filter .12s ease;
    }
    .send:hover{ filter: brightness(1.02); }
    .send:active{ transform: scale(.98); }
    .send:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .status{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(11,18,32,.55);
      min-height: 16px;
    }

    /* small */
    @media (max-width: 420px){
      .bubbleBtn{ right: 12px; bottom: 12px; }
      .panel{ right: 12px; bottom: 12px; height: min(640px, calc(100vh - 24px)); }
      .brandTitle,.brandSub{ max-width: 200px; }
    }
  </style>
</head>

<body>
  <div class="demoTop">
    <div class="demoCard">
      <div class="demoTitle">AI asistent obce ‚Äì DEMO</div>
      <p class="demoSub">Uk√°zka chatu pro obƒçany (kontakty, √∫≈ôedn√≠ hodiny, odpady, poplatky‚Ä¶). Otev≈ôete chat tlaƒç√≠tkem vpravo dole.</p>
      <div class="demoHint">Tip: po≈°lete odkaz ve tvaru <code>/hradec-kralove/</code>, <code>/zeleznice/</code>, <code>/radim/</code></div>
    </div>
  </div>

  <!-- Collapsed bubble button -->
  <div id="bubbleBtn" class="bubbleBtn pulse" role="button" aria-label="Otev≈ô√≠t chat">
    <div class="bubbleIcon">ü§ñ</div>
    <div class="bubbleText">
      <strong>M√°te dotaz?</strong>
      <span>Porad√≠me‚Ä¶</span>
    </div>
    <button class="bubbleCta" type="button">Porad√≠me!</button>
  </div>

  <!-- overlay -->
  <div id="overlay" class="overlay"></div>

  <!-- Expanded chat panel -->
  <aside id="panel" class="panel" aria-label="Chat">
    <div class="topbar">
      <div class="topRow">
        <div class="brand">
          <div class="brandLogo" id="brandLogo" aria-hidden="true">ü§ñ</div>
          <div class="brandText">
            <div class="brandTitle" id="brandTitle">AI asistent obce</div>
            <div class="brandSub" id="brandSub">Uk√°zka DEMO pro obec‚Ä¶</div>
          </div>
        </div>
        <div class="topActions">
          <div class="pill">DEMO</div>
          <button class="iconBtn" id="resetBtn" type="button" title="Reset">‚Ü∫</button>
          <button class="iconBtn" id="closeBtn" type="button" title="Zav≈ô√≠t">‚úï</button>
        </div>
      </div>
    </div>

    <div class="cards">
      <div class="msgCard" id="welcomeCard">
        <div class="tag">V√≠tejte</div>
        <div id="welcomeText">Jsem v√°≈° automatick√Ω asistent. Zeptejte se na to, co v√°s zaj√≠m√°.</div>
      </div>
      <div class="msgCard warning">
        <div class="tag">Upozornƒõn√≠</div>
        Nevkl√°dejte pros√≠m do textu Va≈°e osobn√≠ √∫daje. Odpovƒõdi generovan√© AI maj√≠ pouze informativn√≠ charakter a pravdivost si ovƒõ≈ôte na webu obce.
      </div>
    </div>

    <div class="quick">
      <span class="chip" data-q="Jak√© jsou √∫≈ôedn√≠ hodiny?">√ö≈ôedn√≠ hodiny</span>
      <span class="chip" data-q="Jak√Ω je kontakt na mƒõstsk√Ω/obecn√≠ √∫≈ôad?">Kontakt</span>
      <span class="chip" data-q="Kde je bioodpad a kdy je otev≈ôeno?">Bioodpad</span>
      <span class="chip" data-q="Jak se plat√≠ poplatek za odpad?">Poplatek</span>
      <span class="chip" data-q="Kde na webu najdu √∫≈ôedn√≠ desku?">√ö≈ôedn√≠ deska</span>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="composer">
      <div class="composerRow">
        <input id="inp" type="text" placeholder="Pi≈°te zde‚Ä¶" autocomplete="off" />
        <button id="send" class="send" type="button" aria-label="Odeslat">‚û§</button>
      </div>
      <div class="status" id="status"></div>
    </div>
  </aside>

  <script>
    const bubbleBtn = document.getElementById('bubbleBtn');
    const panel = document.getElementById('panel');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('closeBtn');
    const resetBtn = document.getElementById('resetBtn');

    const chat = document.getElementById('chat');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');

    const brandTitle = document.getElementById('brandTitle');
    const brandSub = document.getElementById('brandSub');
    const brandLogo = document.getElementById('brandLogo');
    const welcomeText = document.getElementById('welcomeText');

    function getParam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }
    function normalizeSlug(value) {
      if (!value) return "";
      return value.toLowerCase().trim()
        .replace(/%20/g, "-")
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "");
    }
    function inferSlugFromUrl() {
      const parts = location.pathname.split('/').filter(Boolean).map(x => x.toLowerCase());
      if (parts.length) {
        if ((parts[0] === "demo" || parts[0] === "obec") && parts[1]) return normalizeSlug(parts[1]);
        return normalizeSlug(parts[0]);
      }
      return normalizeSlug(getParam("obec") || "radim") || "radim";
    }
    let slug = inferSlugFromUrl();

    // background skin
    (function applySkin(){
      const url = `/skins/${slug}.jpg`;
      document.body.style.setProperty('--skin-url', `url("${url}")`);
      document.body.classList.add('has-skin');
    })();

    function openChat(){
      panel.classList.add('open');
      overlay.classList.add('open');
      bubbleBtn.classList.remove('pulse');
      setTimeout(() => inp.focus(), 70);
    }
    function closeChat(){
      panel.classList.remove('open');
      overlay.classList.remove('open');
    }
    bubbleBtn.addEventListener('click', openChat);
    closeBtn.addEventListener('click', closeChat);
    overlay.addEventListener('click', closeChat);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeChat(); });

    // linkify
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s)]+)\b/g;
      return String(text).replace(urlRegex, (url) => {
        const safe = url.replace(/"/g, "%22");
        return `<a href="${safe}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    // sanitize (pojistka proti ‚ÄúSources/404/„Äê„Äë‚Äù)
    function sanitizeAnswer(text){
      if (!text) return text;
      return String(text)
        .replace(/„Äê[^„Äë]{1,200}„Äë/g, "")
        .replace(/^\s*(zdroj|zdroje|source|sources|citace|reference)s?\s*:.*$/gim, "")
        .replace(/404|not found|cannot fetch|error fetching/gi, "")
        .replace(/\n{3,}/g, "\n\n")
        .trim();
    }

    function add(role, text) {
      const wrap = document.createElement('div');
      wrap.className = 'row ' + (role === 'user' ? 'user' : 'ai');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerHTML = linkify(text);
      wrap.appendChild(b);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    async function loadRegistry() {
      try {
        const res = await fetch('/registry/municipalities.json', { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }
    function pickMunicipality(reg, slug) {
      if (!reg) return null;
      if (Array.isArray(reg)) return reg.find(m => m && (m.slug === slug || m.id === slug)) || null;
      if (Array.isArray(reg.municipalities)) return reg.municipalities.find(m => m && (m.slug === slug || m.id === slug)) || null;
      if (reg[slug]) return { slug, ...reg[slug] };
      return null;
    }

    const THREAD_KEY = () => `municipality_thread_id_v6_${slug}`;
    let threadId = localStorage.getItem(THREAD_KEY()) || null;

    async function init(){
      const reg = await loadRegistry();
      const m = pickMunicipality(reg, slug);
      const displayName = m?.name || slug;

      brandTitle.textContent = "AI asistent obce";
      brandSub.textContent = `Uk√°zka DEMO pro: ${displayName}`;
      welcomeText.textContent = `V√≠tejte na str√°nk√°ch obce ${displayName}. Jsem v√°≈° automatick√Ω asistent. Zeptejte se na to, co v√°s zaj√≠m√°.`;

      // logo: kdy≈æ m√° obec logo_url, pou≈æij; jinak ü§ñ
      if (m?.logo_url) {
        brandLogo.innerHTML = `<img src="${m.logo_url}" alt="logo" />`;
      } else {
        brandLogo.textContent = "ü§ñ";
      }

      // prvn√≠ zpr√°va do chatu (nen√≠ to ‚Äúkarta‚Äù, ale chat zpr√°va)
      add('ai', `Dobr√Ω den üëã Jsem uk√°zkov√Ω AI asistent pro obec ${displayName}. Jak v√°m mohu pomoci?`);
    }

    async function ask(q){
      const msg = (q ?? inp.value).trim();
      if (!msg) return;

      openChat();

      add('user', msg);
      inp.value = '';
      sendBtn.disabled = true;
      statusEl.textContent = 'Generuje se odpovƒõƒè‚Ä¶';

      add('ai', 'Chvilku‚Ä¶');
      const loadingEl = chat.lastElementChild;

      try{
        const res = await fetch('/.netlify/functions/search', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ message: msg, thread_id: threadId, obec: slug })
        });

        const data = await res.json().catch(() => ({}));
        if (loadingEl) loadingEl.remove();

        if (!res.ok || !data.ok){
          add('ai', 'Omlouv√°m se, teƒè se mi nepoda≈ôilo odpovƒõdƒõt. Zkuste to pros√≠m znovu.');
          statusEl.textContent = '';
        } else {
          const answer = sanitizeAnswer(data.answer || '');
          add('ai', answer || 'Omlouv√°m se, nepoda≈ôilo se mi naj√≠t odpovƒõƒè.');

          if (data.thread_id){
            threadId = data.thread_id;
            localStorage.setItem(THREAD_KEY(), threadId);
          }
          statusEl.textContent = '';
        }
      } catch(e){
        if (loadingEl) loadingEl.remove();
        add('ai', 'Omlouv√°m se, do≈°lo k chybƒõ p≈ôipojen√≠. Zkuste to pros√≠m znovu.');
        statusEl.textContent = '';
      } finally {
        sendBtn.disabled = false;
        inp.focus();
      }
    }

    sendBtn.addEventListener('click', () => ask());
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') ask(); });

    document.querySelectorAll('[data-q]').forEach(el => {
      el.addEventListener('click', () => ask(el.getAttribute('data-q')));
    });

    function resetConversation(){
      localStorage.removeItem(THREAD_KEY());
      threadId = null;
      chat.innerHTML = '';
      add('ai', `Resetov√°no. Zeptejte se znovu (obec: ${slug}).`);
      inp.focus();
    }
    resetBtn.addEventListener('click', resetConversation);

    init();
  </script>
</body>
</html>
