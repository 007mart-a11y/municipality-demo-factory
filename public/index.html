<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI asistent obce ‚Äì DEMO</title>

  <style>
    :root{
      --accent:#00E5FF;
      --text:#e8eefc;
      --muted: rgba(232,238,252,.72);

      --glass: rgba(10,16,28,.46);
      --glass2: rgba(10,16,28,.22);
      --stroke: rgba(255,255,255,.14);

      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --radius: 18px;
    }

    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      color: var(--text);
      background: #0b1220;
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
    }

    /* ===== Background ===== */
    .bg{
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(1200px 700px at 25% 0%, rgba(0,229,255,.14), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)),
        #0b1220;
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(11,18,32,.82), rgba(11,18,32,.38));
      pointer-events:none;
    }
    .bgImg{
      position:absolute; inset:0;
      background-size: cover;
      background-position: center;
      filter: saturate(1.02) contrast(1.02);
      opacity: .92;
      transform: scale(1.02);
    }
    .bgVignette{
      position:absolute; inset:0;
      background: radial-gradient(1200px 900px at 30% 20%, transparent 40%, rgba(0,0,0,.55) 100%);
      pointer-events:none;
    }

    /* ===== Hint card ===== */
    .hintWrap{
      position: relative;
      z-index: 1;
      max-width: 1060px;
      margin: 18px auto 0;
      padding: 0 18px;
    }
    .hint{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding: 14px 16px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(10,16,28,.52);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .hint .dot{
      width: 38px; height: 38px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,229,255,.12);
      border: 1px solid rgba(0,229,255,.20);
      flex: 0 0 auto;
      font-weight: 900;
    }
    .hint .t{ min-width:0; }
    .hint .t .h{ font-weight: 900; letter-spacing:.2px; }
    .hint .t .s{
      margin-top: 4px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .hint code{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
    }

    /* ===== Floating tab "Porad√≠me v√°m" ===== */
    .tab{
      position: fixed;
      right: 14px;
      bottom: 22px;
      z-index: 50;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,16,28,.56);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.48);
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, background .2s ease;
    }
    .tab:hover{ transform: translateY(-1px); background: rgba(10,16,28,.66); }

    .tab .pill{
      height: 34px;
      padding: 0 14px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      font-weight: 900;
      background: linear-gradient(180deg, rgba(0,229,255,.18), rgba(0,229,255,.10));
      border: 1px solid rgba(0,229,255,.25);
    }
    .tab .mini{
      display:flex; flex-direction:column;
      gap:2px;
      line-height:1.1;
      max-width: 220px;
    }
    .tab .mini .a{ font-weight: 900; font-size: 12px; }
    .tab .mini .b{ font-size: 11px; color: var(--muted); white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .tab.blink{ animation: pulse 1.8s infinite ease-in-out; }
    @keyframes pulse{
      0%,100%{ box-shadow: 0 18px 50px rgba(0,0,0,.48); }
      50%{ box-shadow: 0 18px 50px rgba(0,229,255,.22); }
    }

    /* ===== Panel shell ===== */
    .panel{
      position: fixed;
      right: 14px;
      bottom: 14px;
      width: 392px;
      height: 640px;
      max-height: calc(100dvh - 28px);
      z-index: 60;

      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,16,28,.56);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);

      display:none;
      overflow:hidden;
    }
    .panel.open{ display:flex; flex-direction:column; }

    .panelHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .phLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .badgeIcon{
      width: 34px; height: 34px;
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 900;
      flex:0 0 auto;
    }
    .phTitleWrap{ min-width:0; }
    .phTitle{
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 250px;
    }
    .phSub{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 250px;
    }
    .phRight{ display:flex; align-items:center; gap:8px; }
    .chip{
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .iconBtn{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size: 14px;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.08); }

    /* ===== Quick chips ===== */
    .pillbar{
      padding: 10px 12px 2px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pillChip{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .2s ease;
    }
    .pillChip:hover{ background: rgba(255,255,255,.07); transform: translateY(-1px); }

    /* ===== Chat area (NO frame) ===== */
    .chat{
      flex: 1 1 auto;
      padding: 14px 12px 10px;
      overflow:auto;
      background: transparent;
    }

    /* Jiƒç√≠n-like: real ‚Äúblocks‚Äù stacked */
    .row{ display:flex; margin: 10px 0; }
    .row.user{ justify-content:flex-end; }
    .row.ai{ justify-content:flex-start; }

    .bubble{
      max-width: 86%;
      padding: 10px 12px;
      border-radius: 16px;
      line-height: 1.38;
      font-size: 13px;
      word-break: break-word;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      transform-origin: 80% 100%;
      animation: pop .16s ease-out;
    }
    @keyframes pop{
      from{ transform: translateY(4px) scale(.98); opacity: .0; }
      to{ transform: translateY(0) scale(1); opacity: 1; }
    }

    .row.ai .bubble{
      border-color: rgba(0,229,255,.18);
      background: rgba(0,229,255,.08);
    }
    .row.user .bubble{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .bubble a{ color: var(--accent); text-decoration:none; }
    .bubble a:hover{ text-decoration:underline; }

    /* disclaimer block */
    .disclaimer{
      max-width: 92%;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,16,28,.42);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
      font-size: 12px;
      color: rgba(232,238,252,.75);
      line-height: 1.35;
    }
    .disclaimer b{ color: rgba(232,238,252,.92); }

    /* typing dots */
    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
      vertical-align: middle;
    }
    .typing span{
      width: 7px; height: 7px;
      border-radius: 999px;
      background: rgba(232,238,252,.85);
      opacity: .35;
      animation: bounce 1s infinite ease-in-out;
    }
    .typing span:nth-child(2){ animation-delay: .12s; }
    .typing span:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%, 100%{ transform: translateY(0); opacity: .35; }
      50%{ transform: translateY(-4px); opacity: 1; }
    }

    /* feedback card */
    .feedback{
      max-width: 92%;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,16,28,.46);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
    }
    .feedback .q{ font-weight: 950; margin-bottom: 8px; }
    .feedback .btns{ display:flex; gap:10px; }
    .fbBtn{
      flex: 1;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }
    .fbBtn.yes{
      border-color: rgba(0,229,255,.25);
      background: rgba(0,229,255,.10);
    }
    .fbBtn:hover{ background: rgba(255,255,255,.09); }
    .fbBtn:disabled{ opacity:.55; cursor:not-allowed; }

    /* ===== Input row ===== */
    .inputRow{
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input{
      flex: 1;
      height: 44px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size: 16px; /* iOS zoom fix */
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
    }
    .send{
      width: 44px; height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(0,229,255,.28);
      background: rgba(0,229,255,.12);
      color: var(--text);
      font-weight: 950;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .send:disabled{ opacity:.55; cursor:not-allowed; }

    .foot{
      padding: 0 12px 10px;
      font-size: 11px;
      color: rgba(232,238,252,.58);
    }

    /* ===== Mobile ===== */
    @media (max-width: 520px){
      .panel{
        right: 10px;
        left: 10px;
        width: auto;
        height: calc(100dvh - 20px);
        bottom: 10px;
        border-radius: 18px;
      }
      .phTitle{ max-width: 190px; }
      .phSub{ max-width: 190px; }
      .tab{
        right: 10px;
        bottom: calc(14px + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true">
    <div class="bgImg" id="bgImg"></div>
    <div class="bgVignette"></div>
  </div>

  <div class="hintWrap">
    <div class="hint">
      <div class="dot">AI</div>
      <div class="t">
        <div class="h">AI asistent obce ‚Äì DEMO</div>
        <div class="s">
          Otev≈ôete chat p≈ôes boƒçn√≠ li≈°tu <b>‚ÄûPorad√≠me v√°m‚Äú</b>. P≈ôepnut√≠ obce p≈ôes URL:
          <code>?obec=hradec-kralove</code> / <code>?obec=radim</code> / <code>?obec=zeleznice</code>
        </div>
      </div>
    </div>
  </div>

  <!-- Boƒçn√≠ li≈°ta -->
  <div class="tab blink" id="openTab" role="button" aria-label="Otev≈ô√≠t chat">
    <div class="pill">Porad√≠me v√°m</div>
    <div class="mini">
      <div class="a" id="tabTitle">AI asistent obce</div>
      <div class="b" id="tabSub">Kliknƒõte a napi≈°te dotaz‚Ä¶</div>
    </div>
  </div>

  <!-- Chat panel -->
  <div class="panel" id="panel" aria-live="polite">
    <div class="panelHeader">
      <div class="phLeft">
        <div class="badgeIcon" id="badgeIcon">AI</div>
        <div class="phTitleWrap">
          <div class="phTitle" id="headerTitle">Uk√°zka pro obec</div>
          <div class="phSub" id="headerSub">Zeptejte se na kontakty, √∫≈ôedn√≠ hodiny‚Ä¶</div>
        </div>
      </div>
      <div class="phRight">
        <div class="chip">DEMO</div>
        <button class="iconBtn" id="resetBtn" title="Reset">‚Üª</button>
        <button class="iconBtn" id="closeBtn" title="Zav≈ô√≠t">‚úï</button>
      </div>
    </div>

    <div class="pillbar">
      <span class="pillChip" data-q="Jak√© jsou √∫≈ôedn√≠ hodiny?">√ö≈ôedn√≠ hodiny</span>
      <span class="pillChip" data-q="Jak√Ω je kontakt na √∫≈ôad?">Kontakt</span>
      <span class="pillChip" data-q="Kde je bioodpad a kdy je otev≈ôeno?">Bioodpad</span>
      <span class="pillChip" data-q="Jak se plat√≠ poplatek za odpad?">Poplatek za odpad</span>
      <span class="pillChip" data-q="Kde na webu najdu √∫≈ôedn√≠ desku?">√ö≈ôedn√≠ deska</span>
    </div>

    <div class="chat" id="chat"></div>

    <div class="inputRow">
      <input class="input" id="inp" type="text" placeholder="Napi≈°te dotaz‚Ä¶" autocomplete="off" />
      <button class="send" id="send" type="button">‚û§</button>
    </div>
    <div class="foot" id="status"></div>
  </div>

  <script>
    const openTab = document.getElementById('openTab');
    const panel = document.getElementById('panel');
    const closeBtn = document.getElementById('closeBtn');
    const resetBtn = document.getElementById('resetBtn');

    const chat = document.getElementById('chat');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');

    const headerTitle = document.getElementById('headerTitle');
    const headerSub = document.getElementById('headerSub');
    const tabTitle = document.getElementById('tabTitle');
    const tabSub = document.getElementById('tabSub');
    const badgeIcon = document.getElementById('badgeIcon');
    const bgImg = document.getElementById('bgImg');

    // ===== Helpers =====
    function getParam(name) {
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }
    function normalizeSlug(value) {
      if (!value) return "";
      return value.toLowerCase().trim()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "");
    }

    function inferSlug() {
      const q = normalizeSlug(getParam("obec"));
      if (q) return q;

      const parts = location.pathname.split('/').filter(Boolean).map(x => x.toLowerCase());
      if (!parts.length) return "radim";
      if (parts[0] === "skins" || parts[0] === "registry") return "radim";
      if ((parts[0] === "demo" || parts[0] === "obec") && parts[1]) return normalizeSlug(parts[1]);
      return normalizeSlug(parts[0]) || "radim";
    }

    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s)]+)\b/g;
      return String(text).replace(urlRegex, (url) => {
        const safe = url.replace(/"/g, "%22");
        return `<a href="${safe}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    function addRow(role, innerEl) {
      const row = document.createElement('div');
      row.className = 'row ' + (role === 'user' ? 'user' : 'ai');
      row.appendChild(innerEl);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      return row;
    }

    function addBubble(role, htmlOrText) {
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerHTML = linkify(htmlOrText);
      return addRow(role, b);
    }

    function addDisclaimer() {
      const d = document.createElement('div');
      d.className = 'disclaimer';
      d.innerHTML = `
        <b>Upozornƒõn√≠:</b> Toto je uk√°zkov√Ω AI asistent. Odpovƒõdi mohou b√Ωt nep≈ôesn√© nebo neaktu√°ln√≠.
        Pro z√°vazn√© informace v≈ædy ovƒõ≈ôte √∫daje na ofici√°ln√≠m webu obce nebo p≈ô√≠mo na √∫≈ôadƒõ.
      `;
      return addRow('ai', d);
    }

    function addTyping() {
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerHTML = `<span class="typing" aria-label="Generuje se odpovƒõƒè">
        <span></span><span></span><span></span>
      </span>`;
      return addRow('ai', b);
    }

    async function loadRegistry() {
      try {
        const res = await fetch('/registry/municipalities.json', { cache: 'no-store' });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    function pickMunicipality(reg, slug) {
      if (!reg) return null;
      if (Array.isArray(reg)) return reg.find(m => m && (m.slug === slug || m.id === slug)) || null;
      if (Array.isArray(reg.municipalities)) return reg.municipalities.find(m => m && (m.slug === slug || m.id === slug)) || null;
      if (reg[slug]) return { slug, ...reg[slug] };
      return null;
    }

    async function setBackgroundForSlug(slug) {
      // D≈ÆLE≈ΩIT√â: background oƒçek√°v√°me jako /public/skins/{slug}/bg.jpg
      // -> v repo tedy: public/skins/hradec-kralove/bg.jpg
      const url = `/skins/${slug}/bg.jpg`;

      // m√≠sto HEAD pou≈æ√≠v√°me preload p≈ôes Image (spolehlivƒõj≈°√≠ v nƒõkter√Ωch p≈ô√≠padech)
      await new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url + `?v=${Date.now()}`;
      }).then(ok => {
        bgImg.style.backgroundImage = ok ? `url('${url}')` : '';
      });
    }

    // ---- State
    let slug = inferSlug();

    const THREAD_KEY = () => `municipality_thread_id_v3_${slug}`;
    let threadId = localStorage.getItem(THREAD_KEY()) || null;

    let regCache = null;
    let muni = null;

    // feedback after 2 questions
    let userQCount = 0;
    let feedbackShown = false;

    function openPanel() {
      panel.classList.add('open');
      openTab.classList.remove('blink');
      openTab.style.display = 'none';
      setTimeout(() => inp.focus(), 50);
    }
    function closePanel() {
      panel.classList.remove('open');
      openTab.style.display = 'flex';
      openTab.classList.add('blink');
    }

    function resetConversation() {
      localStorage.removeItem(THREAD_KEY());
      threadId = null;
      userQCount = 0;
      feedbackShown = false;

      chat.innerHTML = '';
      addDisclaimer();
      const name = muni?.name || slug;
      addBubble('ai', `Dobr√Ω den üëã Jsem uk√°zkov√Ω AI asistent pro obec <b>${name}</b>. Jak v√°m mohu pomoci?`);
      inp.focus();
    }

    function showFeedbackCard() {
      if (feedbackShown) return;
      feedbackShown = true;

      const phone = muni?.contact_phone || muni?.phone || muni?.tel || null;

      const box = document.createElement('div');
      box.className = 'feedback';
      box.innerHTML = `
  <div class="q">Na≈°li jste odpovƒõƒè?</div>
  <div class="btns">
    <button class="fbBtn yes" data-fb="yes">Ano</button>
    <button class="fbBtn" data-fb="no">Ne</button>
  </div>
`;
      addRow('ai', box);

      box.querySelectorAll('button[data-fb]').forEach(btn => {
        btn.addEventListener('click', () => {
          const val = btn.dataset.fb;
          box.querySelectorAll('button').forEach(b => b.disabled = true);

          if (val === 'yes') {
            addBubble('ai', 'Super üëç Jsem r√°d, ≈æe jsem pomohl. Kdykoliv se zeptejte znovu.');
          } else {
            addBubble(
              'ai',
              'Mrz√≠ mƒõ to üôè Zkuste dotaz up≈ôesnit, nebo ovƒõ≈ôte informace na ofici√°ln√≠m webu obce ƒçi p≈ô√≠mo na √∫≈ôadƒõ.'
            );
          }
        });
      });
    }

    async function ask(text) {
      const msg = (text ?? inp.value).trim();
      if (!msg) return;

      addBubble('user', msg);
      inp.value = '';
      sendBtn.disabled = true;

      const typing = addTyping();

      try {
        const res = await fetch('/.netlify/functions/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: msg,
            thread_id: threadId,
            obec: slug
          })
        });

        const data = await res.json();
        typing.remove();

        if (!data.ok) {
          addBubble('ai', 'Omlouv√°m se, nepoda≈ôilo se z√≠skat odpovƒõƒè.');
        } else {
          addBubble('ai', data.answer || 'Odpovƒõƒè nebyla nalezena.');

          if (data.thread_id) {
            threadId = data.thread_id;
            localStorage.setItem(THREAD_KEY(), threadId);
          }

          userQCount++;
          if (userQCount >= 2) showFeedbackCard();
        }
      } catch (e) {
        typing.remove();
        addBubble('ai', 'Do≈°lo k chybƒõ spojen√≠. Zkuste to pros√≠m znovu.');
      } finally {
        sendBtn.disabled = false;
        inp.focus();
      }
    }

    // ===== EVENTS =====
    openTab.onclick = openPanel;
    closeBtn.onclick = closePanel;
    resetBtn.onclick = resetConversation;

    sendBtn.onclick = () => ask();
    inp.addEventListener('keydown', e => {
      if (e.key === 'Enter') ask();
    });

    document.querySelectorAll('[data-q]').forEach(el => {
      el.onclick = () => ask(el.dataset.q);
    });

    init();
  </script>
</body>
</html>
